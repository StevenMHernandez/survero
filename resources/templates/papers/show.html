{% extends 'base.html' %}

{% block css %}
<style>
    .sr-only {
        display: none;
    }
</style>
{% endblock %}

{% block title %}
{{ item.title }} - Survero
{% endblock %}

{% block content %}
{% raw %}

<div id="app" v-cloak>
    <div class="container">
        <div class="row">
            <h1>
                {{ item.title }}
            </h1>
            <h5>
                <span v-for="a,i in item.authors">
                    <span v-if="i>0">,</span>
                    <a v-bind:href="'/authors/' + a.creatorID">
                        {{a.firstName}} {{a.lastName}}
                    </a>
                </span>
            </h5>
            <h6 class="text-muted" v-for="c in item.collections">(Collection: {{ c.collectionName }})</h6>
            <b-container fluid class="p-4 bg-dark">
                <b-row>
                    <b-col v-for="s in item.screenshots">
                        <b-img thumbnail fluid v-bind:src="'/uploads/' + s.file_name"></b-img>
                    </b-col>
                </b-row>
            </b-container>
            <br>
            <hr>
            <ul>
                <li v-for="a in item.attachments">
                    <b-input-group v-bind:prepend="a.key" class="mt-3">
                        <b-form-input type="text" v-on:click="copy"
                                      v-bind:value="'open ' + (a.path.replace('storage:', ''))">
                        </b-form-input>
                    </b-input-group>
                </li>
            </ul>
            <hr>


            <b-col>
                <b-input-group prepend="Add a Tag" class="mt-3">

                    <typeahead
                            ref="typeahead"
                            v-model="new_tag_text"
                            v-bind:data="allTags"
                            v-bind:min-matching-chars="1"
                            v-bind:show-on-focus="true"
                            @hit="addTag"
                            @keyup.enter="addTag">
                    </typeahead>
                    <b-input-group-append>
                        <b-button v-on:click="addTag">Create</b-button>
                    </b-input-group-append>
                </b-input-group>
                <ul>
                    <li v-for="t in item.tags">
                        {{ t.tag }}
                        <small class="text-danger" v-on:click="deleteTag(t)">(X)</small>
                    </li>
                    <hr v-if="deletedTags.length > 0">
                    <li v-for="t in deletedTags" class="text-muted">
                        Deleted:
                        <del>{{ t }}</del>
                    </li>
                </ul>
            </b-col>

            <b-col>
                <b-input-group prepend="Add a Note" class="mt-3">

                    <input
                            class="form-control"
                            ref="typeahead"
                            v-model="new_note_text"
                            @keyup.enter="addNote"/>
                    <b-input-group-append>
                        <b-button v-on:click="addNote">Create</b-button>
                    </b-input-group-append>
                </b-input-group>
                <ul>
                    <li v-for="n in item.notes">
                        {{ n.note }}
                    </li>
                </ul>
            </b-col>
        </div>
    </div>
    <vuefullscreenfiledrop @drop='onDrop'></vuefullscreenfiledrop>
</div>
{% endraw %}

{% endblock %}


{% block script %}
<script>
    window.onload = () => {

        Vue.component('vuefullscreenfiledrop', VueFullScreenFileDrop);
        Vue.component('typeahead', VueTypeaheadBootstrap);
        new Vue({
            el: '#app',
            data() {
                return {
                    isBusy: false,
                    item: {},
                    ZOTERO_PATH: '{{ config("application.zotero_path") }}',
                    new_tag_text: '',
                    new_note_text: '',
                    allTags: [],
                    deletedTags: [],
                }
            },
            methods: {
                reload() {
                    axios.get('/api/papers/{{ item.key }}')
                        .then(response => {
                            this.item = response.data;
                            document.title = this.item.title;

                            axios.get('/api/tags/')
                                .then(response => {
                                    this.allTags = response.data.map(t => {
                                        return t.tag
                                    }).filter(t => {
                                        return !this.item.tags.map(x => x.tag).includes(t);
                                    });
                                });
                        });

                },
                onDrop(formData, files) {
                    formData.set('paper_key', '{{ item.key }}');
                    formData.set('__token', '{{ csrf_token }}');
                    axios({
                        method: "post",
                        url: '/api/screenshots',
                        data: formData,
                        headers: {"Content-Type": "multipart/form-data"},
                    }).then(response => {
                        this.reload();
                    });
                },
                addTag() {
                    if (this.new_tag_text !== '') {
                        axios({
                            method: "post",
                            url: '/api/tags',
                            data: {
                                '__token': '{{ csrf_token }}',
                                'paper_key': '{{ item.key }}',
                                'tag': this.new_tag_text,
                            },
                        }).then(response => {
                            this.reload();
                            this.new_tag_text = '';
                            this.$refs.typeahead.$refs.input.focus();
                        });
                    }
                },
                deleteTag(tag) {
                    this.deletedTags.push(tag.tag);
                    axios({
                        method: "delete",
                        url: '/api/tags/' + tag.id,
                        data: {
                            '__token': '{{ csrf_token }}',
                        },
                    }).then(response => {
                        this.reload();
                    });
                },
                addNote() {
                    if (this.new_note_text !== '') {
                        axios({
                            method: "post",
                            url: '/api/notes',
                            data: {
                                '__token': '{{ csrf_token }}',
                                'paper_key': '{{ item.key }}',
                                'note': this.new_note_text,
                            },
                        }).then(response => {
                            this.reload();
                            this.new_note_text = '';
                        });
                    }
                },
                copy(e, i) {
                    console.log(e, i);
                    e.target.select();
                    document.execCommand("copy");
                }
            },
            mounted() {
                this.reload()
            }
        })
    }
</script>
{% endblock %}
